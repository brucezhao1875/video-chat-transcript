> ⚠️ 本文档为2025年5月历史需求，部分内容已与当前设计和实现不符。请以 docs/architect.md、docs/design.md 等最新文档为准。

##  隆波帕默尊者视频语义搜索系统需求文档（对话框形式与后端管理）

### 1. 项目概述

#### 1.1 项目目标
开发一个基于 `txtai` 的语义搜索系统，利用隆波帕默尊者视频的字幕文件构建数据库，以对话框形式实现语义搜索功能，并提供后端管理功能。 
用户通过自然语言查询，系统返回匹配字幕文本 + 跳转链接；管理员可提交视频与字幕，系统自动更新数据库。

#### 1.2 项目背景
隆波帕默尊者的视频内容涉及禅修、佛教哲学等，字幕信息丰富，通过语义搜索形式可增强用户交互体验与内容发现。通过对话框形式的语义搜索，用户可以以自然交互的方式快速定位相关视频片段。
后端管理功能简化了数据库更新流程，提高系统的可维护性。

#### 1.3 预期成果
- 语义搜索系统 + 对话框界面
- 搜索结果带跳转链接
- 后端管理界面支持视频提交 + 字幕下载
- 支持本地/云端部署

### 2. 功能需求

#### 2.1 数据采集
- 视频收集：手动/YouTube API/后端管理
- 字幕下载：`youtube-transcript-api`，支持中英文
- 字幕分段：按时间段（建议10-30秒），每段记录起止时间、内容、跳转链接

#### 2.2 数据处理
- 文本清洗：去除[音乐]等无关内容，格式规范化
- 存储格式：JSON 或 SQLite  
示例：
json
{
  "video_id": "VIDEO_ID",
  "text": "这段话是关于禅修的讲解...",
  "start_second": 120,
  "end_second": 150,
  "url": "https://yourdomain.com/player?video=lp_0001&t=765s"
}


#### 2.3 部署（国内可访问）
- 方案一：国内 CDN（阿里云 OSS + CDN）
- 方案二：国外服务器 + Cloudflare 中国加速
- 播放器：使用 `video.js` 或 `hls.js`

#### 2.3 语义搜索
- 嵌入模型：`sentence-transformers/all-MiniLM-L6-v2`
- 构建嵌入数据库：支持增量更新
- 查询：自然语言，返回前 N 条（默认3），含：
  - 匹配字幕
  - 跳转链接
  - 匹配度（0~1）

#### 2.4 用户界面（对话框）
- 网页对话框，模拟聊天界面
- 交互功能：
  - 输入框 + 消息显示区
  - 自动滚动
  - 匹配内容 + 跳转链接 + 匹配度
- 附加功能：
  - “加载更多”
  - “清空对话”
  - 提示语

#### 2.5 后端管理
- 网页管理界面 + API
- 功能：
  - 提交视频链接
  - 自动下载字幕、处理、索引
  - 视频列表查看、删除、重新处理
  - 状态反馈
- 认证机制：用户名/密码 或 API Key
- 日志记录

#### 2.6 API 接口
- 搜索 API（POST）：
 json
{
  "text": "禅修如何帮助内心平静",
  "limit": 3
}
 
- 返回：
 json
{
  "text": "...",
  "url": "...",
  "score": 0.92
}
 
- 管理 API：
  - 添加视频、获取列表、删除视频
  - 强制认证（Token）

### 3. 非功能需求

#### 3.1 性能
- 本地响应 < 1 秒，云端 < 2 秒
- 单视频处理 < 5 分钟，10 视频 < 30 分钟
- 支持 ≥ 500 视频，10000 段字幕
- 支持 ≥ 10 并发查询

#### 3.2 可扩展性
- 增量更新
- 替换嵌入模型
- 多语言（中文/泰语/英文）

#### 3.3 可靠性
- 友好错误处理（如无字幕）
- 跳转误差 < 2 秒
- 防止重复索引

#### 3.4 安全性
- API、管理界面认证
- 密码加密（bcrypt）
- 输入消毒，防止 XSS
- 防 SQL 注入

### 4. 技术要求

#### 4.1 技术栈
- Python 3.10+
- txtai, sentence-transformers, FastAPI, uvicorn
- 前端：HTML + JS（fetch），Tailwind 或 Bootstrap
- 存储：JSON/SQLite + txtai 向量索引

#### 4.2 开发环境
- pip + requirements.txt
- VS Code 或 PyCharm
- Git

#### 4.3 部署环境
- 本地或云（AWS/GCP/Heroku）
- 可用 Nginx/Gunicorn 提升性能

### 5. 数据处理流程
1. 视频列表收集 → 视频 ID  
2. 字幕下载 → 原始字幕  
3. 字幕清洗/分段 → 分段字幕  
4. 向量索引 → txtai 数据库  
5. 查询 → 匹配字幕 + 跳转  
6. 管理 → 视频链接提交 → 数据库更新

### 6. 用户故事
- 用户希望自然语言提问并跳转到相关视频  
- 管理员希望简单提交链接，自动下载与处理  
- 开发者希望系统易维护、可扩展

### 7. 验收标准
- 功能验收：用户能查到结果，跳转准确  
- 性能验收：响应及时，系统支持一定并发  
- 可靠性：错误提示清晰，数据处理无重复  
- 体验：界面友好、对话流畅、可清空对话

### 8. 未来扩展
- 自动更新视频  
- 多模态（帧/语音）搜索  
- 移动端支持  
- 集成 LLM（如 RAG 模型）

### 9. 附录

#### 9.1 参考资源
- https://neuml.github.io/txtai/
- https://pypi.org/project/youtube-transcript-api/
- https://huggingface.co/sentence-transformers
- https://fastapi.tiangolo.com/

#### 9.2 术语表
- **语义搜索**：基于意义的搜索方式  
- **嵌入向量**：文本的向量化表示  
- **跳转链接**：带时间点的视频链接  
- **对话框**：聊天风格界面  
- **后端管理**：视频/字幕处理功能
